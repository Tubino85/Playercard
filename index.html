<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Playercard • Roster & Rotazioni</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0e0f11; --panel:#15171a; --muted:#9aa3ad; --text:#e9eef4; --acc:#5ac8fa;
      --card:#1b1e22; --line:#2a2f36; --soft:#24282e; --ok:#3ddc97; --warn:#ff9f1c; --danger:#ef476f; --radius:16px; }
    *{box-sizing:border-box}
    body{margin:0;background:#0d1015;color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{position:sticky;top:0;z-index:5;background:#0f1319ee;backdrop-filter:blur(6px);border-bottom:1px solid #1d222b;padding:20px}
    h1{margin:0;font-size:20px}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .section{margin:18px 0 8px;font-size:18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .btn{background:var(--acc);color:#031017;border:0;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
    .btn.alt{background:#11151b;color:var(--text);border:1px solid var(--line)}
    .hint{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:repeat(2,1fr)} .grid-3{grid-template-columns:repeat(3,1fr)}
    .card{background:linear-gradient(180deg,var(--card),#161a1f);border:1px solid var(--line);border-radius:16px;padding:14px}
    label{display:block;color:#b9c3cf;font-size:12px;margin-bottom:6px}
    input,select{width:100%;background:#12161c;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:9px 10px}
    input[disabled]{opacity:.9}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid #222831;text-align:center}
    th{background:#12161c}
    .pill{display:inline-block;border:1px solid var(--line);background:#0f141b;color:#c8d2df;border-radius:999px;padding:3px 8px;font-size:11px}
    .k{background:var(--soft);border:1px solid #2b3038;border-radius:12px;padding:10px}
    .k b{display:block;font-size:12px;color:#9aa3ad;margin-bottom:6px}
    .posgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .poscell{background:#11161d;border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center}
    .poscell b{display:block;font-size:11px;color:#9aa3ad}
    .msg{margin-top:8px;font-size:12px}
    .msg.warn{color:var(--warn)} .msg.err{color:var(--danger)}
    .invalid{outline:2px solid var(--danger)}
    @media (max-width:980px){ .grid-2,.grid-3,.posgrid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header><div class="wrap"><h1>Playercard • Roster & Rotazioni</h1></div></header>
  <div class="wrap">

    <div class="section">Dati giocatori</div>
    <div class="toolbar">
      <button id="reload" class="btn">Ricarica dati</button>
      <label class="btn alt">Carica JSON<input id="jsonFile" type="file" accept="application/json" hidden></label>
      <span class="hint">Se la pagina è su http/https e <code>players.json</code> è nella stessa cartella, si carica da solo.</span>
    </div>
    <div id="status" class="card"><span class="pill">Nessun database caricato</span></div>

    <div class="section">Roster (12)</div>
    <div id="roster" class="grid grid-2"></div>

    <div class="section">Rotazioni (R1–R6)</div>
    <div id="rotations" class="grid grid-3"></div>
    <div id="ruleMsg" class="msg"></div>

  </div>

  <script>
  // ===== Config / State =====
  const POSITIONS = ["FS","FC","FD","SLS","SLC","SLD"];
  const FRONT_POS = new Set(["FS","FC","FD"]);
  const ROSTER_SIZE = 12;
  let PLAYERS = {}; // id -> record

  // ===== Utils =====
  function normId(raw){
    if(raw==null) return "";
    const s = String(raw).trim().replace(/,/g,'.');
    const n = Number(s);
    if(!Number.isNaN(n)){ const i = Math.round(n); if(Math.abs(n-i)<1e-9) return String(i); return String(n); }
    return s;
  }
  function getPlayer(idRaw){
    const id = normId(idRaw);
    if(!id) return null;
    if(PLAYERS[id]) return PLAYERS[id];
    if(PLAYERS[id+".0"]) return PLAYERS[id+".0"];
    if(id.endsWith(".0") && PLAYERS[id.slice(0,-2)]) return PLAYERS[id.slice(0,-2)];
    return null;
  }
  function stat(p,k){ return Number(p[k]) || 0; }
  function pname(p){ return p.Name || p.name || ""; }
  function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;"); }
  function setStatus(msg, ok){
    const el = document.getElementById("status");
    el.innerHTML = '<span class="pill">'+(ok?'<b>OK</b> • ':'')+escapeHtml(msg)+'</span>';
  }
  function showRuleMsg(text, type="warn"){
    const el = document.getElementById("ruleMsg");
    el.className = "msg "+(type==="err"?"err":"warn");
    el.textContent = text || "";
  }
  function getQueryParam(name){
    const m = new RegExp('[?&]'+name+'=([^&#]*)').exec(location.search);
    return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : '';
  }

  // ===== Ruolo (opzionale, se presente nel JSON) =====
  const ROLE_KEYS = ["ROLE","Role","role","RUOLO","Ruolo","ruolo","POSITION","Position","position","POS","Pos","pos"];
  function roleStr(p){ for(const k of ROLE_KEYS){ if(p && p[k]!=null) return String(p[k]).trim(); } return ""; }
  function roleCode(p){ const s = roleStr(p).toUpperCase(); if(!s) return ""; const m = s.match(/[A-Z]/); return m?m[0]:""; }
  function roleBlockedInFront(p){ const c = roleCode(p); return c==="R" || c==="L"; }

  // ===== Data load =====
  async function loadDefault(){
    if (location.protocol === 'file:'){
      setStatus("Apertura locale (file://): l'autoload è bloccato dal browser. Usa 'Carica JSON' o servi via http (es. GitHub Pages).", false);
      return;
    }
    const tried = [];
    const candidates = [];
    const qp = getQueryParam('data');
    if (qp) candidates.push(qp);
    candidates.push('players.json','players_with_role.json','players_1to1_from_excel.json');

    for (const url of candidates){
      try{
        const r = await fetch(url, { cache: 'no-cache' });
        tried.push(url+':'+(r.status||'ERR'));
        if (!r.ok) continue;
        const data = await r.json();
        PLAYERS = data.playersById || data;
        setStatus(`Caricato ${url} (${Object.keys(PLAYERS).length} giocatori)`, true);
        refreshAll();
        return;
      }catch(e){
        tried.push(url+':ERR');
      }
    }
    setStatus('Impossibile leggere dati. Tentativi → '+tried.join(' | ')+' . Verifica posizione/nome del JSON, usa ?data=nomefile.json oppure il pulsante "Carica JSON".', false);
  }

  function loadFromFile(file){
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const data = JSON.parse(fr.result);
        PLAYERS = data.playersById || data;
        setStatus("Caricato JSON da file ("+Object.keys(PLAYERS).length+" giocatori)", true);
        refreshAll();
      }catch(e){
        setStatus("JSON non valido.", false);
      }
    };
    fr.readAsText(file);
  }

  // ===== Roster =====
  function buildRoster(){
    const root = document.getElementById("roster");
    root.innerHTML = "";
    for(let i=1;i<=ROSTER_SIZE;i++){
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="grid grid-2">
          <div>
            <label>ID</label>
            <input type="text" data-roster-id="${i}" placeholder="es. 1" />
          </div>
          <div>
            <label>Nome</label>
            <input type="text" data-roster-name="${i}" disabled />
          </div>
        </div>
        <div style="margin-top:10px">
          <table>
            <thead><tr><th>ATK</th><th>BLK</th><th>DEF</th><th>SET</th><th>SERV</th></tr></thead>
            <tbody><tr>
              <td data-roster-atk="${i}">—</td>
              <td data-roster-blk="${i}">—</td>
              <td data-roster-def="${i}">—</td>
              <td data-roster-set="${i}">—</td>
              <td data-roster-serv="${i}">—</td>
            </tr></tbody>
          </table>
        </div>`;
      root.appendChild(card);
    }
    for(let i=1;i<=ROSTER_SIZE;i++){
      const input = document.querySelector(`[data-roster-id="${i}"]`);
      input.addEventListener("input", ()=>{ fillRosterLine(i, input.value); refreshRotationOptions(); });
    }
  }
  function fillRosterLine(i, rawId){
    const p = getPlayer(rawId);
    const nameEl = document.querySelector(`[data-roster-name="${i}"]`);
    const t = {
      atk: document.querySelector(`[data-roster-atk="${i}"]`),
      blk: document.querySelector(`[data-roster-blk="${i}"]`),
      def: document.querySelector(`[data-roster-def="${i}"]`),
      set: document.querySelector(`[data-roster-set="${i}"]`),
      serv: document.querySelector(`[data-roster-serv="${i}"]`)
    };
    if(!p){
      nameEl.value = "";
      t.atk.textContent=t.blk.textContent=t.def.textContent=t.set.textContent=t.serv.textContent="—";
      return;
    }
    nameEl.value = pname(p);
    t.atk.textContent = stat(p,"ATK");
    t.blk.textContent = stat(p,"BLK");
    t.def.textContent = stat(p,"DEF");
    t.set.textContent = stat(p,"SET");
    t.serv.textContent = stat(p,"SERV");
  }
  function rosterEntries(){
    const ids = [];
    for(let i=1;i<=ROSTER_SIZE;i++){
      const v = document.querySelector(`[data-roster-id="${i}"]`).value;
      const p = getPlayer(v);
      if(p) ids.push({id:normId(v), name:pname(p)});
    }
    const seen = new Set();
    return ids.filter(x=>{ if(seen.has(x.id)) return false; seen.add(x.id); return true; });
  }

  // ===== Rotazioni =====
  function buildRotations(){
    const root = document.getElementById("rotations");
    root.innerHTML = "";
    for(let r=1;r<=6;r++){
      const c = document.createElement("div");
      c.className = "card";
      const selects =
        `<div class="posgrid">
           <div><label>FS</label><select data-rot="${r}-FS"><option value="">—</option></select></div>
           <div><label>FC</label><select data-rot="${r}-FC"><option value="">—</option></select></div>
           <div><label>FD</label><select data-rot="${r}-FD"><option value="">—</option></select></div>
           <div><label>SLS</label><select data-rot="${r}-SLS"><option value="">—</option></select></div>
           <div><label>SLC</label><select data-rot="${r}-SLC"><option value="">—</option></select></div>
           <div><label>SLD</label><select data-rot="${r}-SLD"><option value="">—</option></select></div>
         </div>`;
      let cellsA="", cellsB="";
      for(const pos of POSITIONS){
        cellsA += `<div class="poscell"><b>${pos}</b><span data-aks="${r}-${pos}">—/—</span></div>`;
        cellsB += `<div class="poscell"><b>${pos}</b><span data-bds="${r}-${pos}">—/—/—</span></div>`;
      }
      c.innerHTML = `
        <h3 style="margin:0 0 8px">Rotazione R${r} <span class="pill">R${r}</span></h3>
        ${selects}
        <div class="grid grid-2" style="margin-top:10px">
          <div class="k"><b>ATK/SET per posizione</b><div class="posgrid">${cellsA}</div></div>
          <div class="k"><b>BLK/DEF/SERV per posizione</b><div class="posgrid">${cellsB}</div></div>
        </div>`;
      root.appendChild(c);
    }
    // listeners
    for(let r=1;r<=6;r++){
      for(const pos of POSITIONS){
        const sel = document.querySelector(`[data-rot="${r}-${pos}"]`);
        sel.addEventListener("change", ()=>{
          // anti-duplicati
          const vals = POSITIONS.map(p=>document.querySelector(`[data-rot="${r}-${p}"]`).value).filter(Boolean);
          const count = vals.filter(v=>v===sel.value).length;
          if(count>1){ sel.value=""; showRuleMsg("ID già usato in R"+r+".", "warn"); }
          // blocco ruolo su posizioni front
          const pl = getPlayer(sel.value);
          if(FRONT_POS.has(pos) && pl && roleBlockedInFront(pl)){
            sel.value=""; showRuleMsg("Ruolo R/L non ammesso in FS/FC/FD.", "err");
            sel.classList.add("invalid"); setTimeout(()=>sel.classList.remove("invalid"),600);
          }
          enforceNoDuplicates(r);
          updateRotation(r);
        });
      }
    }
  }

  function buildOptionsForPos(entries, pos){
    return ['<option value="">—</option>'].concat(
      entries.map(e=>{
        const p = getPlayer(e.id);
        const rlBlocked = FRONT_POS.has(pos) && p && roleBlockedInFront(p);
        const dis = rlBlocked ? ' disabled title="Ruolo R/L non ammesso in FS/FC/FD"' : '';
        return `<option value="${e.id}"${dis}>[${e.id}] ${escapeHtml(e.name)}</option>`;
      })
    ).join("");
  }

  function refreshRotationOptions(){
    const entries = rosterEntries();
    for(let r=1;r<=6;r++){
      for(const pos of POSITIONS){
        const sel = document.querySelector(`[data-rot="${r}-${pos}"]`);
        const prev = sel.value;
        sel.innerHTML = buildOptionsForPos(entries, pos);
        const plPrev = getPlayer(prev);
        if(prev && entries.some(e=>e.id===prev) && !(FRONT_POS.has(pos) && plPrev && roleBlockedInFront(plPrev))){
          sel.value = prev;
        } else {
          sel.value = "";
        }
      }
      enforceNoDuplicates(r);
      updateRotation(r);
    }
  }

  function enforceNoDuplicates(r){
    const sels = POSITIONS.map(pos => document.querySelector(`[data-rot="${r}-${pos}"]`));
    const used = new Set(sels.map(s=>s.value).filter(Boolean));
    sels.forEach(sel=>{
      Array.from(sel.options).forEach(opt=>{
        if(!opt.value){ opt.disabled=false; return; }
        const isMine = sel.value === opt.value;
        const dupDisabled = used.has(opt.value) && !isMine;
        const pos = sel.getAttribute("data-rot").split("-")[1];
        const p = getPlayer(opt.value);
        const rlBlocked = FRONT_POS.has(pos) && p && roleBlockedInFront(p);
        opt.disabled = dupDisabled || rlBlocked;
      });
    });
  }

  function updateRotation(r){
    for(const pos of POSITIONS){
      const sel = document.querySelector(`[data-rot="${r}-${pos}"]`);
      const p = getPlayer(sel.value);
      const a = document.querySelector(`[data-aks="${r}-${pos}"]`);
      const b = document.querySelector(`[data-bds="${r}-${pos}"]`);
      if(!p){ a.textContent="—/—"; b.textContent="—/—/—"; continue; }
      a.textContent = `${stat(p,"ATK")}/${stat(p,"SET")}`;
      b.textContent = `${stat(p,"BLK")}/${stat(p,"DEF")}/${stat(p,"SERV")}`;
    }
  }

  function refreshAll(){ buildRoster(); buildRotations(); refreshRotationOptions(); }

  // ===== Boot & events =====
  document.getElementById("reload").addEventListener("click", loadDefault);
  document.getElementById("jsonFile").addEventListener("change", e=>{
    const f = e.target.files && e.target.files[0]; if (f) loadFromFile(f);
  });
  loadDefault();
  </script>
</body>
</html>
