<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Gioco da Tavolo – Playercard (Roster + Rotazioni con Posizioni)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#0e0f11; --panel:#15171a; --muted:#9aa3ad; --text:#e9eef4; --acc:#5ac8fa; --line:#2a2f36; --card:#1b1e22; --soft:#24282e; --ok:#3ddc97; --warn:#ff9f1c; --danger:#ef476f; --radius:16px; }
    *{box-sizing:border-box}
    body{margin:0;background:#0d1015;color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{position:sticky;top:0;z-index:5;background:#0f1319ee;backdrop-filter:blur(6px);border-bottom:1px solid #1d222b;padding:20px}
    h1{margin:0;font-size:20px}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .section{margin:18px 0 8px;font-size:18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .btn{background:var(--acc);color:#031017;border:0;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
    .btn.alt{background:#11151b;color:var(--text);border:1px solid var(--line)}
    .hint{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:14px}
    .grid-2{grid-template-columns:repeat(2,1fr)} .grid-3{grid-template-columns:repeat(3,1fr)}
    .card{background:linear-gradient(180deg,var(--card),#161a1f);border:1px solid var(--line);border-radius:16px;padding:14px}
    label{display:block;color:#b9c3cf;font-size:12px;margin-bottom:6px}
    input,select{width:100%;background:#12161c;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:9px 10px}
    input[disabled]{opacity:.9}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid #222831;text-align:center}
    th{background:#12161c}
    .pill{display:inline-block;border:1px solid var(--line);background:#0f141b;color:#c8d2df;border-radius:999px;padding:3px 8px;font-size:11px}
    .k{background:var(--soft);border:1px solid #2b3038;border-radius:12px;padding:10px}
    .k b{display:block;font-size:12px;color:#9aa3ad;margin-bottom:6px}
    .posgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .poscell{background:#11161d;border:1px solid var(--line);border-radius:10px;padding:8px;text-align:center}
    .poscell b{display:block;font-size:11px;color:#9aa3ad}
    .msg{margin-top:8px;font-size:12px}
    .msg.warn{color:var(--warn)} .msg.err{color:var(--danger)}
    .invalid{outline:2px solid var(--danger)}
    @media (max-width:980px){ .grid-2,.grid-3,.posgrid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header><div class="wrap"><h1>Playercard • Roster & Rotazioni (FS, FC, FD, SLS, SLC, SLD)</h1></div></header>
  <div class="wrap">

    <div class="section">Dati giocatori</div>
    <div class="toolbar">
      <label class="btn alt">Carica JSON<input id="jsonInput" type="file" accept="application/json" hidden /></label>
      <input id="jsonUrl" type="text" placeholder="players.json" style="max-width:240px" />
      <button id="loadUrlBtn" class="btn">Carica da URL</button>
      <button id="reloadBtn" class="btn">Ricarica auto</button>
      <button id="demoBtn" class="btn">Dati di prova</button>
      <button id="clearBtn" class="btn">Svuota tutto</button>
      <span class="hint">Se la pagina è su http/https e <code>players.json</code> è nella stessa cartella, verrà caricato in automatico.</span>
    </div>

    <div class="card">
      <h3>Stato dati</h3>
      <div class="totals" id="dataStatus"><span class="pill">Nessun database caricato</span></div>
    </div>

    <div class="section">Roster (12)</div>
    <div class="toolbar" style="margin-top:6px">
      <button id="addRoster" class="btn">Aggiungi giocatore</button>
      <button id="removeRoster" class="btn alt">Rimuovi ultimo</button>
      <span class="hint">Roster base 12. Puoi salire fino a 18.</span>
    </div>
    <div id="roster" class="grid grid-2"></div>

    <div class="section">Rotazioni (R1–R6)</div>
    <div id="rotazioni" class="grid grid-3"></div>
    <div id="ruleMsg" class="msg"></div>

  </div>

  <script>
    // ===== Config =====
    const POSITIONS = ["FS","FC","FD","SLS","SLC","SLD"]; // layout: FS-FC-FD | SLS-SLC-SLD
    const FRONT_POS = new Set(["FS","FC","FD"]);
    let ROSTER_SIZE = 12;

    // ===== State =====
    let PLAYERS = {}; // id -> record

    // ===== Utils =====
    function normalizeId(raw){
      if(raw==null) return "";
      const s = String(raw).trim().replace(/,/g,'.');
      const n = Number(s);
      if(!Number.isNaN(n)){ const i = Math.round(n); if(Math.abs(n-i)<1e-9) return String(i); return String(n); }
      return s;
    }
    function getPlayer(idRaw){
      const id = normalizeId(idRaw);
      if(!id) return null;
      if(PLAYERS[id]) return PLAYERS[id];
      if(PLAYERS[id+".0"]) return PLAYERS[id+".0"];
      if(id.endsWith(".0") && PLAYERS[id.slice(0,-2)]) return PLAYERS[id.slice(0,-2)];
      return null;
    }
    function stat(p,k){ return Number(p[k]) || 0; }
    function pname(p){ return p.Name || p.name || ""; }
    function escapeHtml(s){
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;");
    }
    function setDataStatus(msg, ok=false){
      const box = document.getElementById('dataStatus');
      box.innerHTML = '';
      const pill = document.createElement('span'); pill.className='pill';
      pill.innerHTML = (ok?'<b>OK</b> • ':'')+escapeHtml(msg); box.appendChild(pill);
      if(ok){ const n = Object.keys(PLAYERS).length; const p2=document.createElement('span'); p2.className='pill'; p2.innerHTML = '<b>'+n+'</b> giocatori caricati'; box.appendChild(p2);} }

    // ===== Role support (optional) =====
    const ROLE_KEYS = ["Role","ROLE","role","Ruolo","RUOLO","ruolo"]; // se non esiste, nessun blocco
    function readRole(p){ for(const k of ROLE_KEYS){ if(p && p[k]!=null) return String(p[k]).trim(); } return ""; }
    function roleBlockedInFront(p){ const c = readRole(p).toUpperCase(); return c==="R" || c==="L"; }

    // ===== Roster =====
    function buildRoster(){
      const root = document.getElementById('roster'); root.innerHTML='';
      for(let i=1;i<=ROSTER_SIZE;i++) addRosterCard(i);
      wireRosterInputs();
    }
    function addRosterCard(i){
      const root = document.getElementById('roster');
      const card = document.createElement('div'); card.className='card'; card.setAttribute('data-roster-card',i);
      card.innerHTML = `
        <h3>Giocatore #${i}</h3>
        <div class="grid grid-2">
          <div><label>ID</label><input type="text" data-roster-id="${i}" placeholder="es. 1" /></div>
          <div><label>Nome</label><input type="text" data-roster-name="${i}" disabled /></div>
        </div>
        <div style="margin-top:10px">
          <table>
            <thead><tr><th>ATK</th><th>BLK</th><th>DEF</th><th>SET</th><th>SERV</th></tr></thead>
            <tbody><tr>
              <td data-roster-atk="${i}">—</td>
              <td data-roster-blk="${i}">—</td>
              <td data-roster-def="${i}">—</td>
              <td data-roster-set="${i}">—</td>
              <td data-roster-serv="${i}">—</td>
            </tr></tbody>
          </table>
        </div>`;
      root.appendChild(card);
    }
    function wireRosterInputs(){
      for(let i=1;i<=ROSTER_SIZE;i++){
        const input = document.querySelector(`[data-roster-id="${i}"]`);
        input.addEventListener('input',()=>{ fillRosterLine(i,input.value); refreshRotationOptions(); });
      }
    }
    function fillRosterLine(i, rawId){
      const p = getPlayer(rawId);
      const nameEl = document.querySelector(`[data-roster-name="${i}"]`);
      const el = {
        atk: document.querySelector(`[data-roster-atk="${i}"]`),
        blk: document.querySelector(`[data-roster-blk="${i}"]`),
        def: document.querySelector(`[data-roster-def="${i}"]`),
        set: document.querySelector(`[data-roster-set="${i}"]`),
        serv: document.querySelector(`[data-roster-serv="${i}"]`)
      };
      if(!p){ nameEl.value=''; Object.values(el).forEach(td=>td.textContent='—'); return; }
      nameEl.value = pname(p);
      el.atk.textContent = stat(p,'ATK'); el.blk.textContent = stat(p,'BLK'); el.def.textContent = stat(p,'DEF'); el.set.textContent = stat(p,'SET'); el.serv.textContent = stat(p,'SERV');
    }
    function rosterEntries(){
      const out=[]; for(let i=1;i<=ROSTER_SIZE;i++){ const v=document.querySelector(`[data-roster-id="${i}"]`).value; const p=getPlayer(v); if(p) out.push({id:normalizeId(v), name:pname(p)}); }
      const seen=new Set(); return out.filter(e=>{ if(seen.has(e.id)) return false; seen.add(e.id); return true; });
    }

    // ===== Rotazioni =====
    function buildRotations(){
      const root=document.getElementById('rotazioni'); root.innerHTML='';
      for(let r=1;r<=6;r++){
        const c=document.createElement('div'); c.className='card';
        let selects='';
        for(const pos of POSITIONS){
          selects += `<div><label>${pos}</label><select data-rot="${r}-${pos}"><option value="">—</option></select></div>`;
        }
        let cellsA='',cellsB='';
        for(const pos of POSITIONS){
          cellsA += `<div class="poscell"><b>${pos}</b><span data-aks="${r}-${pos}">—/—</span></div>`;
          cellsB += `<div class="poscell"><b>${pos}</b><span data-bds="${r}-${pos}">—/—/—</span></div>`;
        }
        c.innerHTML = `
          <h3 style="margin:0 0 8px">Rotazione R${r} <span class="pill">R${r}</span></h3>
          <div class="posgrid">${selects}</div>
          <div class="grid grid-2" style="margin-top:10px">
            <div class="k"><b>ATK/SET per posizione</b><div class="posgrid">${cellsA}</div></div>
            <div class="k"><b>BLK/DEF/SERV per posizione</b><div class="posgrid">${cellsB}</div></div>
          </div>`;
        root.appendChild(c);
      }
      for(let r=1;r<=6;r++){
        for(const pos of POSITIONS){
          const sel=document.querySelector(`[data-rot="${r}-${pos}"]`);
          sel.addEventListener('change',()=>{
            // anti-duplicati
            const vals = POSITIONS.map(p=>document.querySelector(`[data-rot="${r}-${p}"]`).value).filter(Boolean);
            const count = vals.filter(v=>v===sel.value).length; if(count>1){ sel.value=''; showRuleMsg(`ID già usato in R${r}.`,'warn'); }
            // blocco ruolo sulle front
            const pl=getPlayer(sel.value); if(FRONT_POS.has(pos) && pl && roleBlockedInFront(pl)){ sel.value=''; showRuleMsg('Ruolo R/L non ammesso in FS/FC/FD.','err'); sel.classList.add('invalid'); setTimeout(()=>sel.classList.remove('invalid'),600); }
            enforceNoDuplicates(r); updateRotation(r);
          });
        }
      }
    }
    function showRuleMsg(t,kind){ const el=document.getElementById('ruleMsg'); el.className='msg '+(kind==='err'?'err':'warn'); el.textContent=t; }
    function buildOptionsForPos(entries,pos){
      return ['<option value="">—</option>'].concat(entries.map(e=>{
        const p=getPlayer(e.id); const block= FRONT_POS.has(pos) && p && roleBlockedInFront(p);
        return `<option value="${e.id}"${block? ' disabled title="Ruolo R/L non ammesso in FS/FC/FD"':''}>[${e.id}] ${escapeHtml(e.name)}</option>`;
      })).join('');
    }
    function refreshRotationOptions(){
      const entries = rosterEntries();
      for(let r=1;r<=6;r++){
        for(const pos of POSITIONS){
          const sel=document.querySelector(`[data-rot="${r}-${pos}"]`);
          const prev=sel.value; sel.innerHTML = buildOptionsForPos(entries,pos);
          const pPrev=getPlayer(prev);
          if(prev && entries.some(e=>e.id===prev) && !(FRONT_POS.has(pos) && pPrev && roleBlockedInFront(pPrev))) sel.value=prev; else sel.value='';
        }
        enforceNoDuplicates(r); updateRotation(r);
      }
    }
    function enforceNoDuplicates(r){
      const sels = POSITIONS.map(pos=>document.querySelector(`[data-rot="${r}-${pos}"]`));
      const used = new Set(sels.map(s=>s.value).filter(Boolean));
      sels.forEach(sel=>{
        Array.from(sel.options).forEach(opt=>{
          if(!opt.value){ opt.disabled=false; return; }
          const isMine = sel.value===opt.value;
          const dupDisabled = used.has(opt.value) && !isMine;
          const pos = sel.getAttribute('data-rot').split('-')[1];
          const p = getPlayer(opt.value); const rlBlocked = FRONT_POS.has(pos) && p && roleBlockedInFront(p);
          opt.disabled = dupDisabled || rlBlocked;
        });
      });
    }
    function updateRotation(r){
      for(const pos of POSITIONS){
        const sel=document.querySelector(`[data-rot="${r}-${pos}"]`);
        const p=getPlayer(sel.value);
        const a=document.querySelector(`[data-aks="${r}-${pos}"]`);
        const b=document.querySelector(`[data-bds="${r}-${pos}"]`);
        if(!p){ a.textContent='—/—'; b.textContent='—/—/—'; continue; }
        a.textContent = `${stat(p,'ATK')}/${stat(p,'SET')}`;
        b.textContent = `${stat(p,'BLK')}/${stat(p,'DEF')}/${stat(p,'SERV')}`;
      }
    }

    // ===== Loaders =====
    async function autoLoad(){
      if(location.protocol==='file:'){ setDataStatus("Apertura locale (file://): usa 'Carica JSON' oppure 'Carica da URL'."); return; }
      try{
        const r = await fetch('players.json', {cache:'no-cache'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json(); PLAYERS = data.playersById || data; setDataStatus('Database caricato da players.json', true); refreshAll();
      }catch(e){ setDataStatus('Impossibile leggere players.json. Usa Carica JSON o specifica un URL.', false); }
    }
    async function loadFromJsonUrl(url){
      try{ const r=await fetch(url,{cache:'no-cache'}); if(!r.ok) throw new Error('HTTP '+r.status); const data=await r.json(); PLAYERS=data.playersById||data; setDataStatus('Database (JSON) da URL: '+url,true); refreshAll(); }
      catch(e){ setDataStatus('Errore caricando '+url+': '+e.message, false); }
    }
    function loadFromJsonFile(file){ const fr=new FileReader(); fr.onload=()=>{ try{ const data=JSON.parse(fr.result); PLAYERS=data.playersById||data; setDataStatus('Database (JSON) da file', true); refreshAll(); }catch(e){ setDataStatus('JSON non valido', false); } }; fr.readAsText(file); }

    // ===== Orchestrazione =====
    function refreshAll(){ buildRoster(); buildRotations(); refreshRotationOptions(); document.getElementById('rosterCountLabel')?.textContent=String(ROSTER_SIZE); }

    // ===== Init =====
    (function init(){
      // base skeleton
      buildRoster(); buildRotations(); setDataStatus('Nessun database caricato'); refreshRotationOptions();
      // events
      document.getElementById('jsonInput').addEventListener('change', e=>{ const f=e.target.files&&e.target.files[0]; if(f) loadFromJsonFile(f); });
      document.getElementById('loadUrlBtn').addEventListener('click', ()=>{ const url=(document.getElementById('jsonUrl').value||'players.json').trim(); loadFromJsonUrl(url); });
      document.getElementById('jsonUrl').addEventListener('keydown', e=>{ if(e.key==='Enter'){ const url=(document.getElementById('jsonUrl').value||'players.json').trim(); loadFromJsonUrl(url); }});
      document.getElementById('addRoster').addEventListener('click', ()=>{ if(ROSTER_SIZE<18){ ROSTER_SIZE++; addRosterCard(ROSTER_SIZE); wireRosterInputs(); refreshRotationOptions(); document.getElementById('rosterCountLabel').textContent=String(ROSTER_SIZE); } });
      document.getElementById('removeRoster').addEventListener('click', ()=>{ if(ROSTER_SIZE>1){ const card=document.querySelector(`[data-roster-card="${ROSTER_SIZE}"]`); if(card) card.remove(); ROSTER_SIZE--; refreshRotationOptions(); document.getElementById('rosterCountLabel').textContent=String(ROSTER_SIZE); } });
      document.getElementById('clearBtn').addEventListener('click', ()=>{ for(let i=1;i<=ROSTER_SIZE;i++){ const id=document.querySelector(`[data-roster-id="${i}"]`); const nm=document.querySelector(`[data-roster-name="${i}"]`); if(id) id.value=''; if(nm) nm.value=''; fillRosterLine(i,''); } for(let r=1;r<=6;r++){ for(const pos of POSITIONS){ const sel=document.querySelector(`[data-rot="${r}-${pos}"]`); if(sel) sel.value=''; } updateRotation(r);} refreshRotationOptions(); });
      document.getElementById('demoBtn').addEventListener('click', ()=>{ PLAYERS={ '1':{ID:'1',Name:'Demo A',ATK:2,BLK:1,DEF:0,SET:1,SERV:2,Role:'S'}, '2':{ID:'2',Name:'Demo B',ATK:1,BLK:0,DEF:1,SET:2,SERV:1,Role:'R'}, '3':{ID:'3',Name:'Demo C',ATK:3,BLK:1,DEF:2,SET:0,SERV:0,Role:'OH'}, '4':{ID:'4',Name:'Demo D',ATK:0,BLK:2,DEF:1,SET:2,SERV:1,Role:'L'}, '5':{ID:'5',Name:'Demo E',ATK:2,BLK:0,DEF:2,SET:1,SERV:1,Role:'MB'}, '6':{ID:'6',Name:'Demo F',ATK:1,BLK:1,DEF:1,SET:1,SERV:1,Role:'OPP'} }; setDataStatus('Database di prova caricato', true); refreshAll(); });
      document.getElementById('reloadBtn').addEventListener('click', autoLoad);
      // auto-load players.json (solo http/https)
      autoLoad();
    })();
  </script>
</body>
</html>
